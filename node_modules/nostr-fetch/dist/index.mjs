var In=Object.defineProperty;var Ln=(t,e)=>{for(var n in e)In(t,n,{get:e[n],enumerable:!0})};var re=class{promise;constructor(){this.promise=new Promise((e,n)=>{this.resolve=r=>{e(r)},this.reject=r=>{n(r)}})}},ke=class extends Error{constructor(){super("channel closed")}},se=class t{#e=[];#t;#n=!1;#s=!1;#o;#r;constructor({highWaterMark:e=void 0}){this.#o=e??Number.POSITIVE_INFINITY}static make(e){let n=new t(e??{});return[n,n]}send(e){if(this.#t!==void 0){this.#t.resolve(e),this.#t=void 0;return}this.#n||this.#e.push(()=>Promise.resolve(e))}error(e){if(this.#t!==void 0){this.#t.reject(e),this.#t=void 0;return}this.#n||this.#e.push(()=>Promise.reject(e))}close(){this.#n||(this.#n=!0,this.#t!==void 0&&(this.#t.reject(new ke),this.#t=void 0))}waitUntilDrained(){return this.#r!==void 0?this.#r.promise:this.#e.length<=this.#o?Promise.resolve():(this.#r=new re,this.#r.promise)}numBufferedItems(){return this.#e.length}get isCompleted(){return this.#n&&this.#e.length===0}recv(){if(this.#e.length>0){let n=this.#e.shift();return this.#r!==void 0&&this.#e.length<=this.#o&&(this.#r.resolve(),this.#r=void 0),n}if(this.#t!==void 0)return()=>Promise.reject(Error("Double receive is not allowed"));let e=new re;return this.#t=e,()=>e.promise}async*[Symbol.asyncIterator](){if(this.#s)throw Error("Iterating a single channel in multiple location is not allowed");for(this.#s=!0;;)try{if(this.isCompleted)break;yield await this.recv()()}catch(e){if(e instanceof ke)break;throw e}}};function Ht(t){if(!Number.isSafeInteger(t)||t<0)throw new Error(`Wrong positive integer: ${t}`)}function kn(t){return t instanceof Uint8Array||t!=null&&typeof t=="object"&&t.constructor.name==="Uint8Array"}function lt(t,...e){if(!kn(t))throw new Error("Expected Uint8Array");if(e.length>0&&!e.includes(t.length))throw new Error(`Expected Uint8Array of length ${e}, not of length=${t.length}`)}function Dt(t){if(typeof t!="function"||typeof t.create!="function")throw new Error("Hash should be wrapped by utils.wrapConstructor");Ht(t.outputLen),Ht(t.blockLen)}function xe(t,e=!0){if(t.destroyed)throw new Error("Hash instance has been destroyed");if(e&&t.finished)throw new Error("Hash#digest() has already been called")}function zt(t,e){lt(t);let n=e.outputLen;if(t.length<n)throw new Error(`digestInto() expects output buffer of length at least ${n}`)}var Fe=typeof globalThis=="object"&&"crypto"in globalThis?globalThis.crypto:void 0;function ut(t){return t instanceof Uint8Array||t!=null&&typeof t=="object"&&t.constructor.name==="Uint8Array"}var Ke=t=>new DataView(t.buffer,t.byteOffset,t.byteLength),j=(t,e)=>t<<32-e|t>>>e,Fn=new Uint8Array(new Uint32Array([287454020]).buffer)[0]===68;if(!Fn)throw new Error("Non little-endian hardware is not supported");var Kn=Array.from({length:256},(t,e)=>e.toString(16).padStart(2,"0"));function jt(t){if(!ut(t))throw new Error("Uint8Array expected");let e="";for(let n=0;n<t.length;n++)e+=Kn[t[n]];return e}function Mn(t){if(typeof t!="string")throw new Error(`utf8ToBytes expected string, got ${typeof t}`);return new Uint8Array(new TextEncoder().encode(t))}function Ce(t){if(typeof t=="string"&&(t=Mn(t)),!ut(t))throw new Error(`expected Uint8Array, got ${typeof t}`);return t}function Wt(...t){let e=0;for(let r=0;r<t.length;r++){let o=t[r];if(!ut(o))throw new Error("Uint8Array expected");e+=o.length}let n=new Uint8Array(e);for(let r=0,o=0;r<t.length;r++){let s=t[r];n.set(s,o),o+=s.length}return n}var ve=class{clone(){return this._cloneInto()}},Wr={}.toString;function Zt(t){let e=r=>t().update(Ce(r)).digest(),n=t();return e.outputLen=n.outputLen,e.blockLen=n.blockLen,e.create=()=>t(),e}function Me(t=32){if(Fe&&typeof Fe.getRandomValues=="function")return Fe.getRandomValues(new Uint8Array(t));throw new Error("crypto.getRandomValues must be defined")}function Pn(t,e,n,r){if(typeof t.setBigUint64=="function")return t.setBigUint64(e,n,r);let o=BigInt(32),s=BigInt(4294967295),i=Number(n>>o&s),a=Number(n&s),c=r?4:0,l=r?0:4;t.setUint32(e+c,i,r),t.setUint32(e+l,a,r)}var Pe=class extends ve{constructor(e,n,r,o){super(),this.blockLen=e,this.outputLen=n,this.padOffset=r,this.isLE=o,this.finished=!1,this.length=0,this.pos=0,this.destroyed=!1,this.buffer=new Uint8Array(e),this.view=Ke(this.buffer)}update(e){xe(this);let{view:n,buffer:r,blockLen:o}=this;e=Ce(e);let s=e.length;for(let i=0;i<s;){let a=Math.min(o-this.pos,s-i);if(a===o){let c=Ke(e);for(;o<=s-i;i+=o)this.process(c,i);continue}r.set(e.subarray(i,i+a),this.pos),this.pos+=a,i+=a,this.pos===o&&(this.process(n,0),this.pos=0)}return this.length+=e.length,this.roundClean(),this}digestInto(e){xe(this),zt(e,this),this.finished=!0;let{buffer:n,view:r,blockLen:o,isLE:s}=this,{pos:i}=this;n[i++]=128,this.buffer.subarray(i).fill(0),this.padOffset>o-i&&(this.process(r,0),i=0);for(let u=i;u<o;u++)n[u]=0;Pn(r,o-8,BigInt(this.length*8),s),this.process(r,0);let a=Ke(e),c=this.outputLen;if(c%4)throw new Error("_sha2: outputLen should be aligned to 32bit");let l=c/4,p=this.get();if(l>p.length)throw new Error("_sha2: outputLen bigger than state");for(let u=0;u<l;u++)a.setUint32(4*u,p[u],s)}digest(){let{buffer:e,outputLen:n}=this;this.digestInto(e);let r=e.slice(0,n);return this.destroy(),r}_cloneInto(e){e||(e=new this.constructor),e.set(...this.get());let{blockLen:n,buffer:r,length:o,finished:s,destroyed:i,pos:a}=this;return e.length=o,e.pos=a,e.finished=s,e.destroyed=i,o%n&&e.buffer.set(r),e}};var _n=(t,e,n)=>t&e^~t&n,qn=(t,e,n)=>t&e^t&n^e&n,Un=new Uint32Array([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]),oe=new Uint32Array([1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225]),ie=new Uint32Array(64),ft=class extends Pe{constructor(){super(64,32,8,!1),this.A=oe[0]|0,this.B=oe[1]|0,this.C=oe[2]|0,this.D=oe[3]|0,this.E=oe[4]|0,this.F=oe[5]|0,this.G=oe[6]|0,this.H=oe[7]|0}get(){let{A:e,B:n,C:r,D:o,E:s,F:i,G:a,H:c}=this;return[e,n,r,o,s,i,a,c]}set(e,n,r,o,s,i,a,c){this.A=e|0,this.B=n|0,this.C=r|0,this.D=o|0,this.E=s|0,this.F=i|0,this.G=a|0,this.H=c|0}process(e,n){for(let u=0;u<16;u++,n+=4)ie[u]=e.getUint32(n,!1);for(let u=16;u<64;u++){let S=ie[u-15],w=ie[u-2],E=j(S,7)^j(S,18)^S>>>3,f=j(w,17)^j(w,19)^w>>>10;ie[u]=f+ie[u-7]+E+ie[u-16]|0}let{A:r,B:o,C:s,D:i,E:a,F:c,G:l,H:p}=this;for(let u=0;u<64;u++){let S=j(a,6)^j(a,11)^j(a,25),w=p+S+_n(a,c,l)+Un[u]+ie[u]|0,f=(j(r,2)^j(r,13)^j(r,22))+qn(r,o,s)|0;p=l,l=c,c=a,a=i+w|0,i=s,s=o,o=r,r=w+f|0}r=r+this.A|0,o=o+this.B|0,s=s+this.C|0,i=i+this.D|0,a=a+this.E|0,c=c+this.F|0,l=l+this.G|0,p=p+this.H|0,this.set(r,o,s,i,a,c,l,p)}roundClean(){ie.fill(0)}destroy(){this.set(0,0,0,0,0,0,0,0),this.buffer.fill(0)}};var Se=Zt(()=>new ft);var yt={};Ln(yt,{bitGet:()=>Wn,bitLen:()=>jn,bitMask:()=>Be,bitSet:()=>Zn,bytesToHex:()=>ue,bytesToNumberBE:()=>U,bytesToNumberLE:()=>qe,concatBytes:()=>X,createHmacDrbg:()=>pt,ensureBytes:()=>K,equalBytes:()=>Dn,hexToBytes:()=>fe,hexToNumber:()=>ht,isBytes:()=>W,numberToBytesBE:()=>Z,numberToBytesLE:()=>Ue,numberToHexUnpadded:()=>Xt,numberToVarBytesBE:()=>Hn,utf8ToBytes:()=>zn,validateObject:()=>ae});var Qt=BigInt(0),_e=BigInt(1),$n=BigInt(2);function W(t){return t instanceof Uint8Array||t!=null&&typeof t=="object"&&t.constructor.name==="Uint8Array"}var Vn=Array.from({length:256},(t,e)=>e.toString(16).padStart(2,"0"));function ue(t){if(!W(t))throw new Error("Uint8Array expected");let e="";for(let n=0;n<t.length;n++)e+=Vn[t[n]];return e}function Xt(t){let e=t.toString(16);return e.length&1?`0${e}`:e}function ht(t){if(typeof t!="string")throw new Error("hex string expected, got "+typeof t);return BigInt(t===""?"0":`0x${t}`)}var Q={_0:48,_9:57,_A:65,_F:70,_a:97,_f:102};function Gt(t){if(t>=Q._0&&t<=Q._9)return t-Q._0;if(t>=Q._A&&t<=Q._F)return t-(Q._A-10);if(t>=Q._a&&t<=Q._f)return t-(Q._a-10)}function fe(t){if(typeof t!="string")throw new Error("hex string expected, got "+typeof t);let e=t.length,n=e/2;if(e%2)throw new Error("padded hex string expected, got unpadded hex of length "+e);let r=new Uint8Array(n);for(let o=0,s=0;o<n;o++,s+=2){let i=Gt(t.charCodeAt(s)),a=Gt(t.charCodeAt(s+1));if(i===void 0||a===void 0){let c=t[s]+t[s+1];throw new Error('hex string expected, got non-hex character "'+c+'" at index '+s)}r[o]=i*16+a}return r}function U(t){return ht(ue(t))}function qe(t){if(!W(t))throw new Error("Uint8Array expected");return ht(ue(Uint8Array.from(t).reverse()))}function Z(t,e){return fe(t.toString(16).padStart(e*2,"0"))}function Ue(t,e){return Z(t,e).reverse()}function Hn(t){return fe(Xt(t))}function K(t,e,n){let r;if(typeof e=="string")try{r=fe(e)}catch(s){throw new Error(`${t} must be valid hex string, got "${e}". Cause: ${s}`)}else if(W(e))r=Uint8Array.from(e);else throw new Error(`${t} must be hex string or Uint8Array`);let o=r.length;if(typeof n=="number"&&o!==n)throw new Error(`${t} expected ${n} bytes, got ${o}`);return r}function X(...t){let e=0;for(let o=0;o<t.length;o++){let s=t[o];if(!W(s))throw new Error("Uint8Array expected");e+=s.length}let n=new Uint8Array(e),r=0;for(let o=0;o<t.length;o++){let s=t[o];n.set(s,r),r+=s.length}return n}function Dn(t,e){if(t.length!==e.length)return!1;let n=0;for(let r=0;r<t.length;r++)n|=t[r]^e[r];return n===0}function zn(t){if(typeof t!="string")throw new Error(`utf8ToBytes expected string, got ${typeof t}`);return new Uint8Array(new TextEncoder().encode(t))}function jn(t){let e;for(e=0;t>Qt;t>>=_e,e+=1);return e}function Wn(t,e){return t>>BigInt(e)&_e}var Zn=(t,e,n)=>t|(n?_e:Qt)<<BigInt(e),Be=t=>($n<<BigInt(t-1))-_e,dt=t=>new Uint8Array(t),Yt=t=>Uint8Array.from(t);function pt(t,e,n){if(typeof t!="number"||t<2)throw new Error("hashLen must be a number");if(typeof e!="number"||e<2)throw new Error("qByteLen must be a number");if(typeof n!="function")throw new Error("hmacFn must be a function");let r=dt(t),o=dt(t),s=0,i=()=>{r.fill(1),o.fill(0),s=0},a=(...u)=>n(o,r,...u),c=(u=dt())=>{o=a(Yt([0]),u),r=a(),u.length!==0&&(o=a(Yt([1]),u),r=a())},l=()=>{if(s++>=1e3)throw new Error("drbg: tried 1000 values");let u=0,S=[];for(;u<e;){r=a();let w=r.slice();S.push(w),u+=r.length}return X(...S)};return(u,S)=>{i(),c(u);let w;for(;!(w=S(l()));)c();return i(),w}}var Gn={bigint:t=>typeof t=="bigint",function:t=>typeof t=="function",boolean:t=>typeof t=="boolean",string:t=>typeof t=="string",stringOrUint8Array:t=>typeof t=="string"||W(t),isSafeInteger:t=>Number.isSafeInteger(t),array:t=>Array.isArray(t),field:(t,e)=>e.Fp.isValid(t),hash:t=>typeof t=="function"&&Number.isSafeInteger(t.outputLen)};function ae(t,e,n={}){let r=(o,s,i)=>{let a=Gn[s];if(typeof a!="function")throw new Error(`Invalid validator "${s}", expected function`);let c=t[o];if(!(i&&c===void 0)&&!a(c,t))throw new Error(`Invalid param ${String(o)}=${c} (${typeof c}), expected ${s}`)};for(let[o,s]of Object.entries(e))r(o,s,!1);for(let[o,s]of Object.entries(n))r(o,s,!0);return t}var P=BigInt(0),k=BigInt(1),de=BigInt(2),Yn=BigInt(3),gt=BigInt(4),Jt=BigInt(5),en=BigInt(8),Qn=BigInt(9),Xn=BigInt(16);function M(t,e){let n=t%e;return n>=P?n:e+n}function Jn(t,e,n){if(n<=P||e<P)throw new Error("Expected power/modulo > 0");if(n===k)return P;let r=k;for(;e>P;)e&k&&(r=r*t%n),t=t*t%n,e>>=k;return r}function H(t,e,n){let r=t;for(;e-- >P;)r*=r,r%=n;return r}function $e(t,e){if(t===P||e<=P)throw new Error(`invert: expected positive integers, got n=${t} mod=${e}`);let n=M(t,e),r=e,o=P,s=k,i=k,a=P;for(;n!==P;){let l=r/n,p=r%n,u=o-i*l,S=s-a*l;r=n,n=p,o=i,s=a,i=u,a=S}if(r!==k)throw new Error("invert: does not exist");return M(o,e)}function er(t){let e=(t-k)/de,n,r,o;for(n=t-k,r=0;n%de===P;n/=de,r++);for(o=de;o<t&&Jn(o,e,t)!==t-k;o++);if(r===1){let i=(t+k)/gt;return function(c,l){let p=c.pow(l,i);if(!c.eql(c.sqr(p),l))throw new Error("Cannot find square root");return p}}let s=(n+k)/de;return function(a,c){if(a.pow(c,e)===a.neg(a.ONE))throw new Error("Cannot find square root");let l=r,p=a.pow(a.mul(a.ONE,o),n),u=a.pow(c,s),S=a.pow(c,n);for(;!a.eql(S,a.ONE);){if(a.eql(S,a.ZERO))return a.ZERO;let w=1;for(let f=a.sqr(S);w<l&&!a.eql(f,a.ONE);w++)f=a.sqr(f);let E=a.pow(p,k<<BigInt(l-w-1));p=a.sqr(E),u=a.mul(u,E),S=a.mul(S,p),l=w}return u}}function tr(t){if(t%gt===Yn){let e=(t+k)/gt;return function(r,o){let s=r.pow(o,e);if(!r.eql(r.sqr(s),o))throw new Error("Cannot find square root");return s}}if(t%en===Jt){let e=(t-Jt)/en;return function(r,o){let s=r.mul(o,de),i=r.pow(s,e),a=r.mul(o,i),c=r.mul(r.mul(a,de),i),l=r.mul(a,r.sub(c,r.ONE));if(!r.eql(r.sqr(l),o))throw new Error("Cannot find square root");return l}}return t%Xn,er(t)}var nr=["create","isValid","is0","neg","inv","sqrt","sqr","eql","add","sub","mul","pow","div","addN","subN","mulN","sqrN"];function mt(t){let e={ORDER:"bigint",MASK:"bigint",BYTES:"isSafeInteger",BITS:"isSafeInteger"},n=nr.reduce((r,o)=>(r[o]="function",r),e);return ae(t,n)}function rr(t,e,n){if(n<P)throw new Error("Expected power > 0");if(n===P)return t.ONE;if(n===k)return e;let r=t.ONE,o=e;for(;n>P;)n&k&&(r=t.mul(r,o)),o=t.sqr(o),n>>=k;return r}function sr(t,e){let n=new Array(e.length),r=e.reduce((s,i,a)=>t.is0(i)?s:(n[a]=s,t.mul(s,i)),t.ONE),o=t.inv(r);return e.reduceRight((s,i,a)=>t.is0(i)?s:(n[a]=t.mul(s,n[a]),t.mul(s,i)),o),n}function bt(t,e){let n=e!==void 0?e:t.toString(2).length,r=Math.ceil(n/8);return{nBitLength:n,nByteLength:r}}function tn(t,e,n=!1,r={}){if(t<=P)throw new Error(`Expected Field ORDER > 0, got ${t}`);let{nBitLength:o,nByteLength:s}=bt(t,e);if(s>2048)throw new Error("Field lengths over 2048 bytes are not supported");let i=tr(t),a=Object.freeze({ORDER:t,BITS:o,BYTES:s,MASK:Be(o),ZERO:P,ONE:k,create:c=>M(c,t),isValid:c=>{if(typeof c!="bigint")throw new Error(`Invalid field element: expected bigint, got ${typeof c}`);return P<=c&&c<t},is0:c=>c===P,isOdd:c=>(c&k)===k,neg:c=>M(-c,t),eql:(c,l)=>c===l,sqr:c=>M(c*c,t),add:(c,l)=>M(c+l,t),sub:(c,l)=>M(c-l,t),mul:(c,l)=>M(c*l,t),pow:(c,l)=>rr(a,c,l),div:(c,l)=>M(c*$e(l,t),t),sqrN:c=>c*c,addN:(c,l)=>c+l,subN:(c,l)=>c-l,mulN:(c,l)=>c*l,inv:c=>$e(c,t),sqrt:r.sqrt||(c=>i(a,c)),invertBatch:c=>sr(a,c),cmov:(c,l,p)=>p?l:c,toBytes:c=>n?Ue(c,s):Z(c,s),fromBytes:c=>{if(c.length!==s)throw new Error(`Fp.fromBytes: expected ${s}, got ${c.length}`);return n?qe(c):U(c)}});return Object.freeze(a)}function nn(t){if(typeof t!="bigint")throw new Error("field order must be bigint");let e=t.toString(2).length;return Math.ceil(e/8)}function Et(t){let e=nn(t);return e+Math.ceil(e/2)}function rn(t,e,n=!1){let r=t.length,o=nn(e),s=Et(e);if(r<16||r<s||r>1024)throw new Error(`expected ${s}-1024 bytes of input, got ${r}`);let i=n?U(t):qe(t),a=M(i,e-k)+k;return n?Ue(a,o):Z(a,o)}var ir=BigInt(0),wt=BigInt(1);function sn(t,e){let n=(o,s)=>{let i=s.negate();return o?i:s},r=o=>{let s=Math.ceil(e/o)+1,i=2**(o-1);return{windows:s,windowSize:i}};return{constTimeNegate:n,unsafeLadder(o,s){let i=t.ZERO,a=o;for(;s>ir;)s&wt&&(i=i.add(a)),a=a.double(),s>>=wt;return i},precomputeWindow(o,s){let{windows:i,windowSize:a}=r(s),c=[],l=o,p=l;for(let u=0;u<i;u++){p=l,c.push(p);for(let S=1;S<a;S++)p=p.add(l),c.push(p);l=p.double()}return c},wNAF(o,s,i){let{windows:a,windowSize:c}=r(o),l=t.ZERO,p=t.BASE,u=BigInt(2**o-1),S=2**o,w=BigInt(o);for(let E=0;E<a;E++){let f=E*c,h=Number(i&u);i>>=w,h>c&&(h-=S,i+=wt);let d=f,g=f+Math.abs(h)-1,R=E%2!==0,T=h<0;h===0?p=p.add(n(R,s[d])):l=l.add(n(T,s[g]))}return{p:l,f:p}},wNAFCached(o,s,i,a){let c=o._WINDOW_SIZE||1,l=s.get(o);return l||(l=this.precomputeWindow(o,c),c!==1&&s.set(o,a(l))),this.wNAF(c,l,i)}}}function xt(t){return mt(t.Fp),ae(t,{n:"bigint",h:"bigint",Gx:"field",Gy:"field"},{nBitLength:"isSafeInteger",nByteLength:"isSafeInteger"}),Object.freeze({...bt(t.n,t.nBitLength),...t,p:t.Fp.ORDER})}function ar(t){let e=xt(t);ae(e,{a:"field",b:"field"},{allowedPrivateKeyLengths:"array",wrapPrivateKey:"boolean",isTorsionFree:"function",clearCofactor:"function",allowInfinityPoint:"boolean",fromBytes:"function",toBytes:"function"});let{endo:n,Fp:r,a:o}=e;if(n){if(!r.eql(o,r.ZERO))throw new Error("Endomorphism can only be defined for Koblitz curves that have a=0");if(typeof n!="object"||typeof n.beta!="bigint"||typeof n.splitScalar!="function")throw new Error("Expected endomorphism with beta: bigint and splitScalar: function")}return Object.freeze({...e})}var{bytesToNumberBE:cr,hexToBytes:lr}=yt,he={Err:class extends Error{constructor(e=""){super(e)}},_parseInt(t){let{Err:e}=he;if(t.length<2||t[0]!==2)throw new e("Invalid signature integer tag");let n=t[1],r=t.subarray(2,n+2);if(!n||r.length!==n)throw new e("Invalid signature integer: wrong length");if(r[0]&128)throw new e("Invalid signature integer: negative");if(r[0]===0&&!(r[1]&128))throw new e("Invalid signature integer: unnecessary leading zero");return{d:cr(r),l:t.subarray(n+2)}},toSig(t){let{Err:e}=he,n=typeof t=="string"?lr(t):t;if(!W(n))throw new Error("ui8a expected");let r=n.length;if(r<2||n[0]!=48)throw new e("Invalid signature tag");if(n[1]!==r-2)throw new e("Invalid signature: incorrect length");let{d:o,l:s}=he._parseInt(n.subarray(2)),{d:i,l:a}=he._parseInt(s);if(a.length)throw new e("Invalid signature: left bytes after parsing");return{r:o,s:i}},hexFromSig(t){let e=l=>Number.parseInt(l[0],16)&8?"00"+l:l,n=l=>{let p=l.toString(16);return p.length&1?`0${p}`:p},r=e(n(t.s)),o=e(n(t.r)),s=r.length/2,i=o.length/2,a=n(s),c=n(i);return`30${n(i+s+4)}02${c}${o}02${a}${r}`}},J=BigInt(0),z=BigInt(1),cs=BigInt(2),on=BigInt(3),ls=BigInt(4);function ur(t){let e=ar(t),{Fp:n}=e,r=e.toBytes||((E,f,h)=>{let d=f.toAffine();return X(Uint8Array.from([4]),n.toBytes(d.x),n.toBytes(d.y))}),o=e.fromBytes||(E=>{let f=E.subarray(1),h=n.fromBytes(f.subarray(0,n.BYTES)),d=n.fromBytes(f.subarray(n.BYTES,2*n.BYTES));return{x:h,y:d}});function s(E){let{a:f,b:h}=e,d=n.sqr(E),g=n.mul(d,E);return n.add(n.add(g,n.mul(E,f)),h)}if(!n.eql(n.sqr(e.Gy),s(e.Gx)))throw new Error("bad generator point: equation left != right");function i(E){return typeof E=="bigint"&&J<E&&E<e.n}function a(E){if(!i(E))throw new Error("Expected valid bigint: 0 < bigint < curve.n")}function c(E){let{allowedPrivateKeyLengths:f,nByteLength:h,wrapPrivateKey:d,n:g}=e;if(f&&typeof E!="bigint"){if(W(E)&&(E=ue(E)),typeof E!="string"||!f.includes(E.length))throw new Error("Invalid key");E=E.padStart(h*2,"0")}let R;try{R=typeof E=="bigint"?E:U(K("private key",E,h))}catch{throw new Error(`private key must be ${h} bytes, hex or bigint, not ${typeof E}`)}return d&&(R=M(R,g)),a(R),R}let l=new Map;function p(E){if(!(E instanceof u))throw new Error("ProjectivePoint expected")}class u{constructor(f,h,d){if(this.px=f,this.py=h,this.pz=d,f==null||!n.isValid(f))throw new Error("x required");if(h==null||!n.isValid(h))throw new Error("y required");if(d==null||!n.isValid(d))throw new Error("z required")}static fromAffine(f){let{x:h,y:d}=f||{};if(!f||!n.isValid(h)||!n.isValid(d))throw new Error("invalid affine point");if(f instanceof u)throw new Error("projective point not allowed");let g=R=>n.eql(R,n.ZERO);return g(h)&&g(d)?u.ZERO:new u(h,d,n.ONE)}get x(){return this.toAffine().x}get y(){return this.toAffine().y}static normalizeZ(f){let h=n.invertBatch(f.map(d=>d.pz));return f.map((d,g)=>d.toAffine(h[g])).map(u.fromAffine)}static fromHex(f){let h=u.fromAffine(o(K("pointHex",f)));return h.assertValidity(),h}static fromPrivateKey(f){return u.BASE.multiply(c(f))}_setWindowSize(f){this._WINDOW_SIZE=f,l.delete(this)}assertValidity(){if(this.is0()){if(e.allowInfinityPoint&&!n.is0(this.py))return;throw new Error("bad point: ZERO")}let{x:f,y:h}=this.toAffine();if(!n.isValid(f)||!n.isValid(h))throw new Error("bad point: x or y not FE");let d=n.sqr(h),g=s(f);if(!n.eql(d,g))throw new Error("bad point: equation left != right");if(!this.isTorsionFree())throw new Error("bad point: not in prime-order subgroup")}hasEvenY(){let{y:f}=this.toAffine();if(n.isOdd)return!n.isOdd(f);throw new Error("Field doesn't support isOdd")}equals(f){p(f);let{px:h,py:d,pz:g}=this,{px:R,py:T,pz:x}=f,b=n.eql(n.mul(h,x),n.mul(R,g)),m=n.eql(n.mul(d,x),n.mul(T,g));return b&&m}negate(){return new u(this.px,n.neg(this.py),this.pz)}double(){let{a:f,b:h}=e,d=n.mul(h,on),{px:g,py:R,pz:T}=this,x=n.ZERO,b=n.ZERO,m=n.ZERO,O=n.mul(g,g),F=n.mul(R,R),C=n.mul(T,T),A=n.mul(g,R);return A=n.add(A,A),m=n.mul(g,T),m=n.add(m,m),x=n.mul(f,m),b=n.mul(d,C),b=n.add(x,b),x=n.sub(F,b),b=n.add(F,b),b=n.mul(x,b),x=n.mul(A,x),m=n.mul(d,m),C=n.mul(f,C),A=n.sub(O,C),A=n.mul(f,A),A=n.add(A,m),m=n.add(O,O),O=n.add(m,O),O=n.add(O,C),O=n.mul(O,A),b=n.add(b,O),C=n.mul(R,T),C=n.add(C,C),O=n.mul(C,A),x=n.sub(x,O),m=n.mul(C,F),m=n.add(m,m),m=n.add(m,m),new u(x,b,m)}add(f){p(f);let{px:h,py:d,pz:g}=this,{px:R,py:T,pz:x}=f,b=n.ZERO,m=n.ZERO,O=n.ZERO,F=e.a,C=n.mul(e.b,on),A=n.mul(h,R),q=n.mul(d,T),N=n.mul(g,x),D=n.add(h,d),y=n.add(R,T);D=n.mul(D,y),y=n.add(A,q),D=n.sub(D,y),y=n.add(h,g);let v=n.add(R,x);return y=n.mul(y,v),v=n.add(A,N),y=n.sub(y,v),v=n.add(d,g),b=n.add(T,x),v=n.mul(v,b),b=n.add(q,N),v=n.sub(v,b),O=n.mul(F,y),b=n.mul(C,N),O=n.add(b,O),b=n.sub(q,O),O=n.add(q,O),m=n.mul(b,O),q=n.add(A,A),q=n.add(q,A),N=n.mul(F,N),y=n.mul(C,y),q=n.add(q,N),N=n.sub(A,N),N=n.mul(F,N),y=n.add(y,N),A=n.mul(q,y),m=n.add(m,A),A=n.mul(v,y),b=n.mul(D,b),b=n.sub(b,A),A=n.mul(D,q),O=n.mul(v,O),O=n.add(O,A),new u(b,m,O)}subtract(f){return this.add(f.negate())}is0(){return this.equals(u.ZERO)}wNAF(f){return w.wNAFCached(this,l,f,h=>{let d=n.invertBatch(h.map(g=>g.pz));return h.map((g,R)=>g.toAffine(d[R])).map(u.fromAffine)})}multiplyUnsafe(f){let h=u.ZERO;if(f===J)return h;if(a(f),f===z)return this;let{endo:d}=e;if(!d)return w.unsafeLadder(this,f);let{k1neg:g,k1:R,k2neg:T,k2:x}=d.splitScalar(f),b=h,m=h,O=this;for(;R>J||x>J;)R&z&&(b=b.add(O)),x&z&&(m=m.add(O)),O=O.double(),R>>=z,x>>=z;return g&&(b=b.negate()),T&&(m=m.negate()),m=new u(n.mul(m.px,d.beta),m.py,m.pz),b.add(m)}multiply(f){a(f);let h=f,d,g,{endo:R}=e;if(R){let{k1neg:T,k1:x,k2neg:b,k2:m}=R.splitScalar(h),{p:O,f:F}=this.wNAF(x),{p:C,f:A}=this.wNAF(m);O=w.constTimeNegate(T,O),C=w.constTimeNegate(b,C),C=new u(n.mul(C.px,R.beta),C.py,C.pz),d=O.add(C),g=F.add(A)}else{let{p:T,f:x}=this.wNAF(h);d=T,g=x}return u.normalizeZ([d,g])[0]}multiplyAndAddUnsafe(f,h,d){let g=u.BASE,R=(x,b)=>b===J||b===z||!x.equals(g)?x.multiplyUnsafe(b):x.multiply(b),T=R(this,h).add(R(f,d));return T.is0()?void 0:T}toAffine(f){let{px:h,py:d,pz:g}=this,R=this.is0();f==null&&(f=R?n.ONE:n.inv(g));let T=n.mul(h,f),x=n.mul(d,f),b=n.mul(g,f);if(R)return{x:n.ZERO,y:n.ZERO};if(!n.eql(b,n.ONE))throw new Error("invZ was invalid");return{x:T,y:x}}isTorsionFree(){let{h:f,isTorsionFree:h}=e;if(f===z)return!0;if(h)return h(u,this);throw new Error("isTorsionFree() has not been declared for the elliptic curve")}clearCofactor(){let{h:f,clearCofactor:h}=e;return f===z?this:h?h(u,this):this.multiplyUnsafe(e.h)}toRawBytes(f=!0){return this.assertValidity(),r(u,this,f)}toHex(f=!0){return ue(this.toRawBytes(f))}}u.BASE=new u(e.Gx,e.Gy,n.ONE),u.ZERO=new u(n.ZERO,n.ONE,n.ZERO);let S=e.nBitLength,w=sn(u,e.endo?Math.ceil(S/2):S);return{CURVE:e,ProjectivePoint:u,normPrivateKeyToScalar:c,weierstrassEquation:s,isWithinCurveOrder:i}}function fr(t){let e=xt(t);return ae(e,{hash:"hash",hmac:"function",randomBytes:"function"},{bits2int:"function",bits2int_modN:"function",lowS:"boolean"}),Object.freeze({lowS:!0,...e})}function an(t){let e=fr(t),{Fp:n,n:r}=e,o=n.BYTES+1,s=2*n.BYTES+1;function i(y){return J<y&&y<n.ORDER}function a(y){return M(y,r)}function c(y){return $e(y,r)}let{ProjectivePoint:l,normPrivateKeyToScalar:p,weierstrassEquation:u,isWithinCurveOrder:S}=ur({...e,toBytes(y,v,B){let L=v.toAffine(),I=n.toBytes(L.x),_=X;return B?_(Uint8Array.from([v.hasEvenY()?2:3]),I):_(Uint8Array.from([4]),I,n.toBytes(L.y))},fromBytes(y){let v=y.length,B=y[0],L=y.subarray(1);if(v===o&&(B===2||B===3)){let I=U(L);if(!i(I))throw new Error("Point is not on curve");let _=u(I),$=n.sqrt(_),V=($&z)===z;return(B&1)===1!==V&&($=n.neg($)),{x:I,y:$}}else if(v===s&&B===4){let I=n.fromBytes(L.subarray(0,n.BYTES)),_=n.fromBytes(L.subarray(n.BYTES,2*n.BYTES));return{x:I,y:_}}else throw new Error(`Point of length ${v} was invalid. Expected ${o} compressed bytes or ${s} uncompressed bytes`)}}),w=y=>ue(Z(y,e.nByteLength));function E(y){let v=r>>z;return y>v}function f(y){return E(y)?a(-y):y}let h=(y,v,B)=>U(y.slice(v,B));class d{constructor(v,B,L){this.r=v,this.s=B,this.recovery=L,this.assertValidity()}static fromCompact(v){let B=e.nByteLength;return v=K("compactSignature",v,B*2),new d(h(v,0,B),h(v,B,2*B))}static fromDER(v){let{r:B,s:L}=he.toSig(K("DER",v));return new d(B,L)}assertValidity(){if(!S(this.r))throw new Error("r must be 0 < r < CURVE.n");if(!S(this.s))throw new Error("s must be 0 < s < CURVE.n")}addRecoveryBit(v){return new d(this.r,this.s,v)}recoverPublicKey(v){let{r:B,s:L,recovery:I}=this,_=m(K("msgHash",v));if(I==null||![0,1,2,3].includes(I))throw new Error("recovery id invalid");let $=I===2||I===3?B+e.n:B;if($>=n.ORDER)throw new Error("recovery id 2 or 3 invalid");let V=I&1?"03":"02",ee=l.fromHex(V+w($)),te=c($),be=a(-_*te),Te=a(L*te),ne=l.BASE.multiplyAndAddUnsafe(ee,be,Te);if(!ne)throw new Error("point at infinify");return ne.assertValidity(),ne}hasHighS(){return E(this.s)}normalizeS(){return this.hasHighS()?new d(this.r,a(-this.s),this.recovery):this}toDERRawBytes(){return fe(this.toDERHex())}toDERHex(){return he.hexFromSig({r:this.r,s:this.s})}toCompactRawBytes(){return fe(this.toCompactHex())}toCompactHex(){return w(this.r)+w(this.s)}}let g={isValidPrivateKey(y){try{return p(y),!0}catch{return!1}},normPrivateKeyToScalar:p,randomPrivateKey:()=>{let y=Et(e.n);return rn(e.randomBytes(y),e.n)},precompute(y=8,v=l.BASE){return v._setWindowSize(y),v.multiply(BigInt(3)),v}};function R(y,v=!0){return l.fromPrivateKey(y).toRawBytes(v)}function T(y){let v=W(y),B=typeof y=="string",L=(v||B)&&y.length;return v?L===o||L===s:B?L===2*o||L===2*s:y instanceof l}function x(y,v,B=!0){if(T(y))throw new Error("first arg must be private key");if(!T(v))throw new Error("second arg must be public key");return l.fromHex(v).multiply(p(y)).toRawBytes(B)}let b=e.bits2int||function(y){let v=U(y),B=y.length*8-e.nBitLength;return B>0?v>>BigInt(B):v},m=e.bits2int_modN||function(y){return a(b(y))},O=Be(e.nBitLength);function F(y){if(typeof y!="bigint")throw new Error("bigint expected");if(!(J<=y&&y<O))throw new Error(`bigint expected < 2^${e.nBitLength}`);return Z(y,e.nByteLength)}function C(y,v,B=A){if(["recovered","canonical"].some(le=>le in B))throw new Error("sign() legacy options not supported");let{hash:L,randomBytes:I}=e,{lowS:_,prehash:$,extraEntropy:V}=B;_==null&&(_=!0),y=K("msgHash",y),$&&(y=K("prehashed msgHash",L(y)));let ee=m(y),te=p(v),be=[F(te),F(ee)];if(V!=null){let le=V===!0?I(n.BYTES):V;be.push(K("extraEntropy",le))}let Te=X(...be),ne=ee;function ct(le){let Ee=b(le);if(!S(Ee))return;let Ut=c(Ee),G=l.BASE.multiply(Ee).toAffine(),we=a(G.x);if(we===J)return;let Le=a(Ut*a(ne+we*te));if(Le===J)return;let $t=(G.x===we?0:2)|Number(G.y&z),Vt=Le;return _&&E(Le)&&(Vt=f(Le),$t^=1),new d(we,Vt,$t)}return{seed:Te,k2sig:ct}}let A={lowS:e.lowS,prehash:!1},q={lowS:e.lowS,prehash:!1};function N(y,v,B=A){let{seed:L,k2sig:I}=C(y,v,B),_=e;return pt(_.hash.outputLen,_.nByteLength,_.hmac)(L,I)}l.BASE._setWindowSize(8);function D(y,v,B,L=q){let I=y;if(v=K("msgHash",v),B=K("publicKey",B),"strict"in L)throw new Error("options.strict was renamed to lowS");let{lowS:_,prehash:$}=L,V,ee;try{if(typeof I=="string"||W(I))try{V=d.fromDER(I)}catch(G){if(!(G instanceof he.Err))throw G;V=d.fromCompact(I)}else if(typeof I=="object"&&typeof I.r=="bigint"&&typeof I.s=="bigint"){let{r:G,s:we}=I;V=new d(G,we)}else throw new Error("PARSE");ee=l.fromHex(B)}catch(G){if(G.message==="PARSE")throw new Error("signature must be Signature instance, Uint8Array or hex string");return!1}if(_&&V.hasHighS())return!1;$&&(v=e.hash(v));let{r:te,s:be}=V,Te=m(v),ne=c(be),ct=a(Te*ne),le=a(te*ne),Ee=l.BASE.multiplyAndAddUnsafe(ee,ct,le)?.toAffine();return Ee?a(Ee.x)===te:!1}return{CURVE:e,getPublicKey:R,getSharedSecret:x,sign:N,verify:D,ProjectivePoint:l,Signature:d,utils:g}}var Ve=class extends ve{constructor(e,n){super(),this.finished=!1,this.destroyed=!1,Dt(e);let r=Ce(n);if(this.iHash=e.create(),typeof this.iHash.update!="function")throw new Error("Expected instance of class which extends utils.Hash");this.blockLen=this.iHash.blockLen,this.outputLen=this.iHash.outputLen;let o=this.blockLen,s=new Uint8Array(o);s.set(r.length>o?e.create().update(r).digest():r);for(let i=0;i<s.length;i++)s[i]^=54;this.iHash.update(s),this.oHash=e.create();for(let i=0;i<s.length;i++)s[i]^=106;this.oHash.update(s),s.fill(0)}update(e){return xe(this),this.iHash.update(e),this}digestInto(e){xe(this),lt(e,this.outputLen),this.finished=!0,this.iHash.digestInto(e),this.oHash.update(e),this.oHash.digestInto(e),this.destroy()}digest(){let e=new Uint8Array(this.oHash.outputLen);return this.digestInto(e),e}_cloneInto(e){e||(e=Object.create(Object.getPrototypeOf(this),{}));let{oHash:n,iHash:r,finished:o,destroyed:s,blockLen:i,outputLen:a}=this;return e=e,e.finished=o,e.destroyed=s,e.blockLen=i,e.outputLen=a,e.oHash=n._cloneInto(e.oHash),e.iHash=r._cloneInto(e.iHash),e}destroy(){this.destroyed=!0,this.oHash.destroy(),this.iHash.destroy()}},vt=(t,e,n)=>new Ve(t,e).update(n).digest();vt.create=(t,e)=>new Ve(t,e);function dr(t){return{hash:t,hmac:(e,...n)=>vt(t,e,Wt(...n)),randomBytes:Me}}function cn(t,e){let n=r=>an({...t,...dr(r)});return Object.freeze({...n(e),create:n})}var je=BigInt("0xfffffffffffffffffffffffffffffffffffffffffffffffffffffffefffffc2f"),He=BigInt("0xfffffffffffffffffffffffffffffffebaaedce6af48a03bbfd25e8cd0364141"),fn=BigInt(1),De=BigInt(2),ln=(t,e)=>(t+e/De)/e;function dn(t){let e=je,n=BigInt(3),r=BigInt(6),o=BigInt(11),s=BigInt(22),i=BigInt(23),a=BigInt(44),c=BigInt(88),l=t*t*t%e,p=l*l*t%e,u=H(p,n,e)*p%e,S=H(u,n,e)*p%e,w=H(S,De,e)*l%e,E=H(w,o,e)*w%e,f=H(E,s,e)*E%e,h=H(f,a,e)*f%e,d=H(h,c,e)*h%e,g=H(d,a,e)*f%e,R=H(g,n,e)*p%e,T=H(R,i,e)*E%e,x=H(T,r,e)*l%e,b=H(x,De,e);if(!Rt.eql(Rt.sqr(b),t))throw new Error("Cannot find square root");return b}var Rt=tn(je,void 0,void 0,{sqrt:dn}),Ct=cn({a:BigInt(0),b:BigInt(7),Fp:Rt,n:He,Gx:BigInt("55066263022277343669578718895168534326250603453777594175500187360389116729240"),Gy:BigInt("32670510020758816978083085130507043184471273380659243275938904335757337482424"),h:BigInt(1),lowS:!0,endo:{beta:BigInt("0x7ae96a2b657c07106e64479eac3434e99cf0497512f58995c1396c28719501ee"),splitScalar:t=>{let e=He,n=BigInt("0x3086d221a7d46bcde86c90e49284eb15"),r=-fn*BigInt("0xe4437ed6010e88286f547fa90abfe4c3"),o=BigInt("0x114ca50f7a8e2f3f657c1108d9d44cfd8"),s=n,i=BigInt("0x100000000000000000000000000000000"),a=ln(s*t,e),c=ln(-r*t,e),l=M(t-a*n-c*o,e),p=M(-a*r-c*s,e),u=l>i,S=p>i;if(u&&(l=e-l),S&&(p=e-p),l>i||p>i)throw new Error("splitScalar: Endomorphism failed, k="+t);return{k1neg:u,k1:l,k2neg:S,k2:p}}}},Se),We=BigInt(0),hn=t=>typeof t=="bigint"&&We<t&&t<je,hr=t=>typeof t=="bigint"&&We<t&&t<He,un={};function ze(t,...e){let n=un[t];if(n===void 0){let r=Se(Uint8Array.from(t,o=>o.charCodeAt(0)));n=X(r,r),un[t]=n}return Se(X(n,...e))}var Bt=t=>t.toRawBytes(!0).slice(1),Ot=t=>Z(t,32),St=t=>M(t,je),Ae=t=>M(t,He),At=Ct.ProjectivePoint,pr=(t,e,n)=>At.BASE.multiplyAndAddUnsafe(t,e,n);function Tt(t){let e=Ct.utils.normPrivateKeyToScalar(t),n=At.fromPrivateKey(e);return{scalar:n.hasEvenY()?e:Ae(-e),bytes:Bt(n)}}function pn(t){if(!hn(t))throw new Error("bad x: need 0 < x < p");let e=St(t*t),n=St(e*t+BigInt(7)),r=dn(n);r%De!==We&&(r=St(-r));let o=new At(t,r,fn);return o.assertValidity(),o}function yn(...t){return Ae(U(ze("BIP0340/challenge",...t)))}function yr(t){return Tt(t).bytes}function gr(t,e,n=Me(32)){let r=K("message",t),{bytes:o,scalar:s}=Tt(e),i=K("auxRand",n,32),a=Ot(s^U(ze("BIP0340/aux",i))),c=ze("BIP0340/nonce",a,o,r),l=Ae(U(c));if(l===We)throw new Error("sign failed: k is zero");let{bytes:p,scalar:u}=Tt(l),S=yn(p,o,r),w=new Uint8Array(64);if(w.set(p,0),w.set(Ot(Ae(u+S*s)),32),!gn(w,r,o))throw new Error("sign: Invalid signature produced");return w}function gn(t,e,n){let r=K("signature",t,64),o=K("message",e),s=K("publicKey",n,32);try{let i=pn(U(s)),a=U(r.subarray(0,32));if(!hn(a))return!1;let c=U(r.subarray(32,64));if(!hr(c))return!1;let l=yn(Ot(a),Bt(i),o),p=pr(i,c,Ae(-l));return!(!p||!p.hasEvenY()||p.toAffine().x!==a)}catch{return!1}}var mn={getPublicKey:yr,sign:gr,verify:gn,utils:{randomPrivateKey:Ct.utils.randomPrivateKey,lift_x:pn,pointToBytes:Bt,numberToBytesBE:Z,bytesToNumberBE:U,taggedHash:ze,mod:M}};var mr=new TextEncoder,Ne=t=>{let e=JSON.stringify([0,t.pubkey,t.created_at,t.kind,t.tags,t.content]),n=jt(Se(mr.encode(e)));return mn.verify(t.sig,n,t.pubkey)};var bn={all:0,verbose:10,info:20,warn:30,error:40,none:50},En={verbose:console.debug,info:console.info,warn:console.warn,error:console.error},Y=class t{#e;#t;#n;constructor(e,n){this.#e=e,this.#t=n??"",this.#n=n?`[${n}]`:""}subLogger(e){return this.#t?new t(this.#e,`${this.#t}:${e}`):new t(this.#e,e)}log(e,n,...r){bn[e]<bn[this.#e]||(this.#n?En[e](`${this.#n} ${n}`,...r):En[e](n,...r))}};var ce=class extends Error{static{this.prototype.name="FetchTillEoseFailedSignal"}},Re=class extends Error{static{this.prototype.name="FetchTillEoseAbortedSignal"}},Ze=t=>t instanceof Error&&t.name==="FetchTillEoseFailedSignal",Ge=t=>t instanceof Error&&t.name==="FetchTillEoseAbortedSignal",Nt={minLogLevel:"warn"};var Ye=(t=new Date)=>t.getTime(),Qe=(t=new Date)=>Math.floor(Ye(t)/1e3),Xe=t=>{let e=new URL(t);return e.pathname=e.pathname.replace(/\/+/g,"/"),e.pathname.endsWith("/")&&(e.pathname=e.pathname.slice(0,-1)),(e.port==="80"&&e.protocol==="ws:"||e.port==="443"&&e.protocol==="wss:")&&(e.port=""),e.searchParams.sort(),e.hash="",e.toString()},br=t=>Array.from(new Set(t)),pe=t=>br(t.filter(e=>{try{return new URL(e),!0}catch{return!1}}).map(e=>Xe(e)));var wn=(t,e)=>{if(t.length<=e*2||e<=0)return t;let n=t.length;return`${t.slice(0,e)}:${t.slice(n-e)}`};var Er={metadata:0,text:1,recommendRelay:2,contacts:3,encryptedDirectMessage:4,eventDeletion:5,repost:6,reaction:7,badgeAward:8,genericRepost:16,channelCreation:40,channelMetadata:41,channelMessage:42,channelHideMessage:43,channelMuteUser:44,fileMetadata:1063,liveChatMessage:1311,report:1984,label:1985,communityPostApproval:4550,zapRequest:9734,zap:9735,muteList:1e4,pinList:10001,relayList:10002,walletInfo:13194,clientAuth:22242,walletRequest:23194,walletResponse:23195,nostrConnect:24133,httpAuth:27235,categorizedPeopleList:3e4,categorizedBookmarkList:30001,profileBadges:30008,badgeDefinition:30009,marketplaceStall:30017,marketplaceProduct:30018,article:30023,draftArticle:30024,appSpecificData:30078,liveEvent:30311,classifiedListing:30402,draftClassifiedListing:30403,dateBasedCalendarEvent:31922,timeBasedCalendarEvent:31923,calendar:31924,calendarEventRsvp:31925,handlerRecommendation:31989,handlerInformation:31990,communityDefinition:34550},wr=["EVENT","EOSE","CLOSED","NOTICE"],xr=t=>wr.includes(t),vn=t=>{let e;try{e=JSON.parse(t)}catch(r){console.error("failed to parse R2C message as JSON:",r);return}if(!Array.isArray(e)||e.length===0||typeof e[0]!="string"){console.error("malformed R2C message");return}let n=e[0];if(!xr(n)){console.error("unsupported R2C message type:",e[0]);return}switch(n){case"EVENT":{if(e.length!==3){console.error("malformed R2C EVENT");return}let[,r,o]=e;if(typeof r!="string"||typeof o!="object"||o===null){console.error("malformed R2C EVENT");return}if(!vr(o)){console.error("malformed event in R2C EVENT");return}return e}case"EOSE":{if(e.length!==2||typeof e[1]!="string"){console.error("malformed R2C EOSE");return}return e}case"CLOSED":{if(e.length!==3||typeof e[1]!="string"||typeof e[2]!="string"){console.error("malformed R2C CLOSED");return}return e}case"NOTICE":{if(e.length!==2){console.error("malformed R2C NOTICE");return}return e}default:return}},vr=t=>!(!("id"in t)||typeof t.id!="string"||!xn(t.id)||!("pubkey"in t)||typeof t.pubkey!="string"||!xn(t.pubkey)||!("created_at"in t)||typeof t.created_at!="number"||!("kind"in t)||typeof t.kind!="number"||!("tags"in t)||!Array.isArray(t.tags)||t.tags.some(e=>!Array.isArray(e)||e.some(n=>typeof n!="string"))||!("content"in t)||typeof t.content!="string"||!("sig"in t)||typeof t.sig!="string"||!Sr(t.sig)),xn=t=>/^[a-f0-9]{64}$/.test(t),Sr=t=>/^[a-f0-9]{128}$/.test(t),Rr=t=>{let e=t.ids?new Set(t.ids):void 0,n=t.kinds?new Set(t.kinds):void 0,r=t.authors?new Set(t.authors):void 0,o=[];for(let s of Object.keys(t))s.startsWith("#")&&s.length===2&&o.push([s.charAt(1),new Set(t[s]??[])]);return{ids:e,kinds:n,authors:r,tags:o,since:t.since,until:t.until}},Or=(t,e)=>t.tags.filter(n=>n[0]===e).map(n=>n[1]??""),Tr=(t,e)=>t.ids!==void 0&&!t.ids.has(e.id)||t.kinds!==void 0&&!t.kinds.has(e.kind)||t.authors!==void 0&&!t.authors.has(e.pubkey)||t.since!==void 0&&e.created_at<t.since||t.until!==void 0&&e.created_at>t.until?!1:t.tags.every(([r,o])=>{let s=Or(e,r);return s.length===0?!1:s.some(i=>o.has(i))}),Je=class{#e;constructor(e){this.#e=e.map(Rr)}match(e){return this.#e.some(n=>Tr(n,e))}},Sn=async t=>{try{let e=Cr(t),n=new AbortController,r=setTimeout(()=>{n.abort()},5e3),o=await fetch(e,{headers:{Accept:"application/nostr+json"},signal:n.signal});if(clearTimeout(r),!o.ok)return console.error("relay information response is not ok"),new Set;let s=await o.json();return Br(s)?new Set(s.supported_nips):(console.error("relay information document doesn't have proper 'supported_nips' property"),new Set)}catch(e){return console.error(e),new Set}},Cr=t=>{let e=new URL(t);switch(e.protocol){case"wss:":e.protocol="https:";break;case"ws:":e.protocol="http:";break}return e.toString()},Br=t=>typeof t=="object"&&t!==null&&"supported_nips"in t&&Array.isArray(t.supported_nips)&&(t.supported_nips.length===0||t.supported_nips.every(e=>typeof e=="number")),Rn=()=>Date.now().toString()+Math.random().toString(32).substring(2,4),Ar=[/^too many concurrent REQs$/i,/^Subscription rejected/i,/^invalid:(.*)must (contain|be) less than or equal to/i,/^message too large$/i,/^Maximum concurrent subscription count reached$/i],On=t=>Ar.some(e=>e.test(t));var Tn=(t,e)=>new It(t,e),It=class{#e;#t;#n;#s={connect:new Set,disconnect:new Set,notice:new Set,error:new Set};#o=new Map;#r=[];#i;constructor(e,n){this.#e=e,this.#n=n}get url(){return this.#e}get wsReadyState(){return this.#t?.readyState??0}forwardToSub(e,n){let r=this.#o.get(e);r!==void 0&&n(r)}handleMsgs(){if(this.#r.length===0){clearInterval(this.#i),this.#i=void 0;return}let e=performance.now();for(;this.#r.length>0&&performance.now()-e<5;){let n=this.#r.shift(),r=vn(n);if(r!==void 0)switch(r[0]){case"EVENT":{let[,o,s]=r;this.forwardToSub(o,i=>i._forwardEvent(s));break}case"EOSE":{let[,o]=r;this.forwardToSub(o,s=>s._forwardEose());break}case"CLOSED":{let[,o,s]=r;this.forwardToSub(o,i=>i._forwardClosed(s));break}case"NOTICE":{let[,o]=r;this.#s.notice.forEach(s=>s(o));break}}}}async connect(){return new Promise((e,n)=>{let r=!1,o=setTimeout(()=>{r=!0,n(Error(`attempt to connect to the relay '${this.#e}' timed out`))},this.#n.connectTimeoutMs),s=new WebSocket(this.#e);s.onopen=()=>{r||(this.#s.connect.forEach(i=>i()),this.#t=s,s.onerror=()=>{this.#s.error.forEach(i=>i())},e(this),clearTimeout(o))},s.onerror=()=>{n(Error("WebSocket error")),clearTimeout(o)},s.onclose=i=>{let a={code:i.code,reason:i.reason,wasClean:i.wasClean};this.#s.disconnect.forEach(c=>c(a))},s.onmessage=i=>{this.#r.push(i.data),this.#i===void 0&&(this.#i=setInterval(()=>this.handleMsgs(),0))}})}close(){this.#t!==void 0&&this.#t.close()}prepareSub(e,n){let r=n.subId??Rn(),o=new Lt(this,r,e,n);return this.#o.set(r,o),o}_removeSub(e){this.#o.delete(e)}on(e,n){this.#s[e].add(n)}off(e,n){this.#s[e].delete(n)}_sendC2RMessage(e){if(this.#t===void 0||this.#t.readyState!==1)throw Error("not connected to the relay");this.#t.send(JSON.stringify(e))}},Lt=class{#e;#t;#n;#s;#o;#r={event:new Set,eose:new Set,closed:new Set};#i;constructor(e,n,r,o){this.#e=e,this.#t=n,this.#n=r,this.#s=new Je(r),this.#o=o}get subId(){return this.#t}req(){this.#e._sendC2RMessage(["REQ",this.#t,...this.#n]),this.#c()}close(){this.#a(),this.#e._removeSub(this.#t),this.#e._sendC2RMessage(["CLOSE",this.#t])}on(e,n){this.#r[e].add(n)}off(e,n){this.#r[e].delete(n)}#a(){for(let e of Object.values(this.#r))e.clear()}#c(){this.#i!==void 0&&(clearTimeout(this.#i),this.#i=void 0),this.#i=setTimeout(()=>{this.#r.eose.forEach(e=>e({aborted:!0}))},this.#o.abortSubBeforeEoseTimeoutMs)}_forwardEvent(e){this.#c(),!(!this.#o.skipVerification&&!Ne(e))&&(!this.#o.skipFilterMatching&&!this.#s.match(e)||this.#r.event.forEach(n=>n(e)))}_forwardEose(){this.#i!==void 0&&clearTimeout(this.#i),this.#r.eose.forEach(e=>e({aborted:!1}))}_forwardClosed(e){this.#r.closed.forEach(n=>n(e)),this.#a(),this.#e._removeSub(this.#t)}};var Ir=4e3,Cn=t=>new kt(t),Lr=30*1e3,kr=10*1e3,kt=class{#e=new Map;#t;#n;constructor(e){e.minLogLevel!=="none"&&(this.#n=new Y(e.minLogLevel)),this.#t=setInterval(()=>{this.#n?.log("info","watchdog started");let n=Array.from(this.#e.keys());this.addRelays(n,{connectTimeoutMs:kr}).then(()=>{this.#n?.log("info","watchdog completed")})},Lr)}#s(e){return e.state==="connectFailed"&&Ye()-e.failedAt>30*1e3||e.state==="disconnected"&&e.reconnectable||e.state==="alive"&&e.relay.wsReadyState===3}async addRelays(e,n){let r=[],o=[];for(let s of e){let i=this.#e.get(s);i===void 0||this.#s(i)?r.push(s):i.state==="connecting"&&o.push(i.wait)}await Promise.all([...r.map(async s=>{let i=this.#n?.subLogger(s),a=new re;try{this.#e.set(s,{state:"connecting",relayUrl:s,wait:a.promise});let c=Tn(s,n);c.on("connect",()=>i?.log("info","connected")),c.on("disconnect",l=>{i?.log("info",`disconnected: ${JSON.stringify(l)}`),this.#e.set(c.url,{state:"disconnected",relayUrl:c.url,reconnectable:l.code!==Ir})}),c.on("error",()=>{i?.log("error","WebSocket error"),this.#e.set(c.url,{state:"disconnected",relayUrl:c.url,reconnectable:!0})}),c.on("notice",l=>i?.log("warn",`NOTICE: ${l}`)),await c.connect(),this.#e.set(s,{state:"alive",relayUrl:s,relay:c})}catch{i?.log("error","failed to connect to the relay"),this.#e.set(s,{state:"connectFailed",relayUrl:s,failedAt:Ye()})}finally{a.resolve()}}),...o])}async ensureRelays(e,n){let r=pe(e);await this.addRelays(r,n);let o=[];for(let s of r){let i=this.#e.get(s);i!==void 0&&i.state==="alive"&&o.push(i.relay.url)}return o}async ensureSingleRelay(e,n){let r=Xe(e);await this.addRelays([r],n);let o=this.#e.get(r);if(o!==void 0&&o.state==="alive")return o.relay}shutdown(){clearInterval(this.#t);for(let[,e]of this.#e)e.state==="alive"&&e.relay.close();this.#e.clear()}};var et=class{#e;#t;constructor(e){this.#e=Cn(e),e.minLogLevel!=="none"&&(this.#t=new Y(e.minLogLevel))}async ensureRelays(e,n){return this.#e.ensureRelays(e,n)}shutdown(){this.#e.shutdown()}async*fetchTillEose(e,n,r){let o=this.#t?.subLogger(e),s=await this.#e.ensureSingleRelay(e,r);if(s===void 0)throw new ce("failed to ensure connection to the relay");let[i,a]=se.make(),c=w=>{if(On(w)){try{u.close()}catch(E){o?.log("error",`failed to close subscription (id: ${u.subId}): ${E}`)}p(),i.error(new ce(`NOTICE: ${w}`))}},l=()=>{p(),i.error(new ce("WebSocket error"))},p=()=>{s.off("notice",c),s.off("error",l)};s.on("notice",c),s.on("error",l);let u=s.prepareSub([n],r);u.on("event",w=>{i.send(w)}),u.on("eose",({aborted:w})=>{S(),w?i.error(new Re(`subscription (id: ${u.subId}) aborted before EOSE due to timeout`)):i.close()}),u.on("closed",w=>{i.error(new ce(`subscription (id: ${u.subId}) closed by relay: ${w}`))});let S=()=>{try{u.close()}catch(w){o?.log("error",`failed to close subscription (id: ${u.subId}): ${w}`)}p(),o?.log("verbose",`CLOSE: subId=${r.subId??"<auto>"}`)};o?.log("verbose",`REQ: subId=${r.subId??"<auto>"}, filter=%O`,n);try{u.req()}catch(w){i.error(new ce("failed to send REQ",{cause:w})),p()}r.abortSignal?.aborted&&(S(),i.error(new Re(`subscription (id: ${u.subId}) aborted by AbortController`))),r.abortSignal?.addEventListener("abort",()=>{S(),i.error(new Re(`subscription (id: ${u.subId}) aborted by AbortController`))}),yield*a}};var ye=class extends Error{static{this.prototype.name="NostrFetchError"}};var ge=(t,e,n)=>{let r=[];for(let o of e){let s=o(t);switch(s.severity){case"error":n?.log("error",`assertion error: ${s.msg}`),r.push(s.msg);break;case"warn":n?.log("warn",`warning: ${s.msg}`);break}}if(r.length>0){let o=r.map(s=>`- ${s}`).join(`
`);throw new ye(`Invalid request!
${o}`)}};function rt(t,e,n){return r=>t(r)?{severity:"none"}:{severity:e,msg:n}}function me(t,e,n){return r=>t(r).length!==0?{severity:"none"}:{severity:e,msg:n}}function Pt(t,e,n){return r=>{let{since:o,until:s}=t(r);return o===void 0||s===void 0?{severity:"none"}:o<=s?{severity:"none"}:{severity:e,msg:n}}}var st=(t,e)=>e.created_at-t.created_at,Bn=(t,e)=>{switch(t){case"ids":return[e.id];case"authors":return[e.pubkey];case"kinds":return[e.kind]}let n=e.tags.filter(r=>r[0]===t.charAt(1)).map(r=>r[1]??"");return[...new Set(n)]},tt=class{#e;#t;constructor(e,n){this.#e=new Map(e.map(r=>[r,[]])),this.#t=n}getBucket(e){return this.#e.get(e)}add(e,n){let r=this.#e.get(e);return r===void 0?(console.error(`bucket not found for key: ${e}`),{state:"dropped"}):r.length>=this.#t?{state:"dropped"}:(r.push(n),r.length===this.#t?{state:"fulfilled",events:r}:{state:"open"})}calcKeysAndLimitForNextReq(){return[...this.#e.entries()].reduce(({keys:e,limit:n},[r,o])=>{let s=o.length;return{keys:s<this.#t?[...e,r]:e,limit:n+(this.#t-s)}},{keys:[],limit:0})}},nt=class{#e;#t;constructor(e,n){this.#e=new Map;let r=[...new Set([...e.values()].flat())];this.#t=new Map(r.map(o=>[o,[]]));for(let[o,s]of e)for(let i of s){let a=n();this.#e.set(this.#n(i,o),a),this.#t.get(i).push(a)}}#n(e,n){return`${e}|${n}`}get(e,n){return this.#e.get(this.#n(e,n))}itemsByKey(e){return this.#t.get(e)}},Ft=class{#e=new Map;#t;constructor(e){e.minLogLevel!=="none"&&(this.#t=new Y(e.minLogLevel))}async relaySupportsNips(e,n){let r=this.#t?.subLogger(e);if(n.length===0)return!0;let o=this.#e.get(e);if(o!==void 0)return n.every(i=>o.has(i));let s=await Sn(e);return r?.log("info",`supported NIPs: ${s}`),this.#e.set(e,s),n.every(i=>s.has(i))}},_t=t=>new Ft(t),ot=t=>t?new Kt:new Mt,Kt=class{#e=new Map;report(e,n){let r=this.#e.get(e.id);return r!==void 0?{hasSeen:!0,seenOn:[...r.add(n)]}:(this.#e.set(e.id,new Set([n])),{hasSeen:!1,seenOn:[n]})}getSeenOn(e){return[...this.#e.get(e)??[]]}},Mt=class{#e=new Set;report(e,n){return this.#e.has(e.id)?{hasSeen:!0,seenOn:void 0}:(this.#e.add(e.id),{hasSeen:!1,seenOn:void 0})}getSeenOn(e){return[]}},Oe=class t{#e={progress:{max:1,current:0},counts:{fetchedEvents:0,bufferedEvents:0,openedSubs:0,runningSubs:0}};#t=performance.now();#n=new Map;#s;#o;constructor(e,n){this.#s=e,this.#o=setInterval(()=>{this.#s(this.#r())},n)}#r(){return{...this.#e,elapsedTimeMs:performance.now()-this.#t,relays:Object.fromEntries(this.#n)}}static init(e,n){return e!==void 0?new t(e,n):void 0}setProgressMax(e){this.#e.progress.max=Math.max(e,1)}addProgress(e){this.#e.progress.current+=e}setCurrentProgress(e){this.#e.progress.current=e}eventFetched(e){this.#e.counts.fetchedEvents++;let n=this.#n.get(e);n!==void 0&&n.numFetchedEvents++}setNumBufferedEvents(e){this.#e.counts.bufferedEvents=e}subOpened(){this.#e.counts.openedSubs++,this.#e.counts.runningSubs++}subClosed(){this.#e.counts.runningSubs--}initRelayStats(e,n,r){let o=new Set(n),s=pe(e).filter(c=>!o.has(c));console.log(e,n,s);let i=n.map(c=>[c,{status:"fetching",numFetchedEvents:0,frontier:r}]),a=s.map(c=>[c,{status:"connection-failed",numFetchedEvents:0,frontier:0}]);this.#n=new Map([...i,...a])}setRelayStatus(e,n){let r=this.#n.get(e);r!==void 0&&(r.status=n)}setRelayFrontier(e,n){let r=this.#n.get(e);r!==void 0&&(r.frontier=n)}stop(){this.#o!==void 0&&clearInterval(this.#o),this.#s(this.#r())}},Ie=class{#e;constructor(e){this.#e=new Map(e.map(n=>[n,0]))}addProgress(e,n){let r=this.#e.get(e)??0;this.#e.set(e,r+n)}setProgress(e,n){this.#e.set(e,n)}calcTotalProgress(){return[...this.#e.values()].reduce((e,n)=>e+n)}};var at=5e3,Fr=500,Kr=5e3,qt={skipVerification:!1,skipFilterMatching:!1,withSeenOn:!1,statsListener:void 0,statsNotifIntervalMs:1e3,connectTimeoutMs:5e3,abortSignal:void 0,abortSubBeforeEoseTimeoutMs:1e4,limitPerReq:at},Mr={...qt,enableBackpressure:!1},Pr={...qt,sort:!1},it={...qt,asOf:void 0,reduceVerification:!0},_r=t=>"relayUrls"in t&&"keys"in t,qr=t=>Symbol.iterator in Object(t),Ur=t=>"relayUrls"in t&&"authors"in t,$r=t=>Symbol.iterator in Object(t),An=t=>{if(Ur(t))return{keys:t.authors,relayUrls:t.relayUrls};if($r(t))return t;throw Error("adaptAuthorsAndRelays: unreachable")},Nn=class t{#e;#t;#n;constructor(e,n,r){this.#e=e,this.#t=n,r.minLogLevel!=="none"&&(this.#n=new Y(r.minLogLevel))}static init(e={},n=_t){let r={...Nt,...e},o=new et(r),s=n(r);return new t(o,s,r)}static withCustomPool(e,n={},r=_t){let o={...Nt,...n},s=r(o);return new t(e(o),s,o)}async#s(e,n,r){let o=await this.#e.ensureRelays(e,n);if(r.length===0)return o;this.#n?.log("info",`required NIPs: ${r}`);let s=[];return await Promise.all(o.map(async i=>{await this.#t.relaySupportsNips(i,r)&&s.push(i)})),this.#n?.log("info",`eligible relays: ${s}`),s}#o(e){let n=[];return"search"in e&&n.push(50),n}allEventsIterator(e,n,r,o={}){ge({relayUrls:e,timeRangeFilter:r},[me(a=>a.relayUrls,"warn","Specify at least 1 relay URL"),Pt(a=>a.timeRangeFilter,"error","Invalid time range (since > until)")],this.#n);let s={...Mr,...o},i={...s,limitPerReq:s.enableBackpressure?Math.min(s.limitPerReq,Fr):s.limitPerReq};return this.#n?.log("verbose","finalOpts=%O",i),this.#r(e,n,r,i)}async*#r(e,n,r,o){let s=Oe.init(o.statsListener,o.statsNotifIntervalMs),i=this.#o(n),a=await this.#s(e,o,i),c=o.enableBackpressure?Math.max(o.limitPerReq*a.length,Kr):void 0,[l,p]=se.make({highWaterMark:c}),u=ot(o.withSeenOn),S=r.until??Qe(),w=r.since!==void 0?Math.max(S-r.since+1,1):void 0,E=new Ie(a);s?.setProgressMax(a.length),s?.initRelayStats(e,a,S),Promise.all(a.map(async f=>{let h=this.#n?.subLogger(f),d=S,g=new Set;for(;;){let R={...r,...n,until:d,limit:Math.min(o.limitPerReq,at)};h?.log("verbose","refinedFilter=%O",R);let T=!1,x=Number.MAX_SAFE_INTEGER,b=!1;try{s?.subOpened();for await(let m of this.#e.fetchTillEose(f,R,o))if(!g.has(m.id)){T=!0,g.add(m.id),m.created_at<x&&(x=m.created_at);let{hasSeen:O,seenOn:F}=u.report(m,f);(o.withSeenOn||!O)&&l.send({...m,seenOn:F}),s?.eventFetched(f),s?.setNumBufferedEvents(l.numBufferedItems())}}catch(m){if(Ze(m)){h?.log("error",m),s?.setRelayStatus(f,"failed");break}if(Ge(m))h?.log("info",m.message),b=!0;else{h?.log("error","unexpected error:",m),s?.setRelayStatus(f,"failed");break}}finally{s?.subClosed()}if(!T){h?.log("info",`got ${g.size} events`),s?.setRelayStatus(f,b?"aborted":"completed");break}if(d=x,s?.setRelayFrontier(f,x),w!==void 0&&(E.setProgress(f,(S-x)/w),s?.setCurrentProgress(E.calcTotalProgress())),o.abortSignal?.aborted){h?.log("info","aborted"),s?.setRelayStatus(f,"aborted");break}await l.waitUntilDrained()}E.setProgress(f,1),s?.setCurrentProgress(E.calcTotalProgress())})).then(()=>{l.close(),s?.stop()}),yield*p}async fetchAllEvents(e,n,r,o={}){ge({relayUrls:e,timeRangeFilter:r},[me(c=>c.relayUrls,"warn","Specify at least 1 relay URL"),Pt(c=>c.timeRangeFilter,"error","Invalid time range (since > until)")],this.#n);let s={...Pr,...o},i=this.allEventsIterator(e,n,r,{...s,enableBackpressure:!1}),a=await(async()=>{if(s.withSeenOn){let l=new Map;for await(let p of i)l.set(p.id,p);return[...l.values()]}let c=[];for await(let l of i)c.push(l);return c})();return s.sort&&a.sort(st),a}async fetchLatestEvents(e,n,r,o={}){ge({relayUrls:e,limit:r},[me(d=>d.relayUrls,"warn","Specify at least 1 relay URL"),rt(d=>d.limit>0,"error",'"limit" should be positive number')],this.#n);let s={...it,...o};this.#n?.log("verbose","finalOpts=%O",s);let i={...s,skipVerification:s.skipVerification||s.reduceVerification},a=Oe.init(s.statsListener,s.statsNotifIntervalMs),c=this.#o(n),l=await this.#s(e,s,c),[p,u]=se.make(),S=ot(s.withSeenOn),w=s.asOf??Qe(),E=new Ie(l);a?.setProgressMax(l.length*r),a?.initRelayStats(e,l,w),Promise.all(l.map(async d=>{let g=this.#n?.subLogger(d),R=w,T=r,x=new Set;for(;;){let b={...n,until:R,limit:Math.min(T,at)};g?.log("verbose","refinedFilter=%O",b);let m=0,O=Number.MAX_SAFE_INTEGER,F=!1;try{a?.subOpened();for await(let C of this.#e.fetchTillEose(d,b,i))if(!x.has(C.id)){m++,x.add(C.id),C.created_at<O&&(O=C.created_at);let{hasSeen:A}=S.report(C,d);A||p.send(C),a?.eventFetched(d),a?.setNumBufferedEvents(p.numBufferedItems())}}catch(C){if(Ze(C)){g?.log("error",C),a?.setRelayStatus(d,"failed");break}if(Ge(C))g?.log("info",C.message),F=!0;else{g?.log("error","unexpected error:",C),a?.setRelayStatus(d,"failed");break}}finally{a?.subClosed()}if(E.addProgress(d,Math.min(m,T)),a?.setCurrentProgress(E.calcTotalProgress()),T-=m,m===0||T<=0){g?.log("info",`got ${x.size} events`),a?.setRelayStatus(d,F?"aborted":"completed");break}if(s.abortSignal?.aborted){g?.log("info","aborted"),a?.setRelayStatus(d,"aborted");break}R=O,a?.setRelayFrontier(d,O)}E.setProgress(d,r),a?.setCurrentProgress(E.calcTotalProgress())})).then(()=>{p.close(),a?.stop()});let f=[];for await(let d of u)f.push(d);f.sort(st);let h=(()=>{if(s.skipVerification||!s.reduceVerification)return f.slice(0,r);let d=[];for(let g of f)if(Ne(g)&&(d.push(g),d.length>=r))break;return d})();return s.withSeenOn?h.map(d=>({...d,seenOn:S.getSeenOn(d.id)})):h}async fetchLastEvent(e,n,r={}){let o={...it,abortSubBeforeEoseTimeoutMs:1e3,...r};return(await this.fetchLatestEvents(e,n,1,o))[0]}async#i(e,n,r){if(_r(e)){ge(e,[me(i=>i.relayUrls,"warn","Specify at least 1 relay URL"),me(i=>i.keys,"warn","Specify at least 1 key")],this.#n);let o=[...new Set(e.keys)],s=await this.#s(e.relayUrls,n,r);return[new Map(s.map(i=>[i,o])),o,s]}if(qr(e)){let o=[...e];ge(o,[me(l=>l,"warn","Specify at least 1 key"),rt(l=>l.every(([,p])=>p.length>0),"warn","Specify at least 1 relay URL for all keys")],this.#n);let s=[...new Set(o.map(([l])=>l))],i=new Map;for(let[l,p]of o){let u=pe(p);for(let S of u){let w=i.get(S);i.set(S,w?w.add(l):new Set([l]))}}let a=[...i.keys()],c=await this.#s(a,n,r);return[new Map(c.map(l=>[l,[...i.get(l)]])),s,c]}throw new ye("malformed first argument for fetchLatestEventsPerKey/fetchLastEventPerKey")}fetchLatestEventsPerKey(e,n,r,o,s={}){ge({limit:o},[rt(c=>c.limit>0,"error",'"limit" should be positive number')],this.#n);let i={...it,...s};this.#n?.log("verbose","finalOpts=%O",i);let a={...i,skipVerification:i.skipVerification||i.reduceVerification};return this.#a(e,n,r,o,a)}async*#a(e,n,r,o,s){let i=Oe.init(s.statsListener,s.statsNotifIntervalMs),a=this.#o(r),[c,l,p]=await this.#i(n,s,a);this.#n?.log("verbose","relayToKeys=%O",c);let[u,S]=se.make(),w=ot(s.withSeenOn),E=s.asOf??Qe();i?.setProgressMax(l.length),i?.initRelayStats(p,[...c.keys()],E);let f=new nt(c,()=>new re);Promise.all([...c].map(async([h,d])=>{let g=this.#n?.subLogger(h),R=E,T=new tt(d,o),x=new Set,b=()=>{g?.log("verbose","resolving bucket on early return");for(let m of d)f.get(m,h)?.resolve(T.getBucket(m)??[])};for(;;){let{keys:m,limit:O}=T.calcKeysAndLimitForNextReq();if(m.length===0){g?.log("verbose","fulfilled buckets for all keys"),i?.setRelayStatus(h,"completed");break}let F={...r,[e]:m,until:R,limit:Math.min(O,at)};g?.log("verbose","refinedFilter=%O",F);let C=!1,A=Number.MAX_SAFE_INTEGER,q=!1;try{i?.subOpened();for await(let N of this.#e.fetchTillEose(h,F,s))if(!x.has(N.id)){C=!0,x.add(N.id),N.created_at<A&&(A=N.created_at),w.report(N,h);for(let D of Bn(e,N)){let y=T.add(D,N);y.state==="fulfilled"&&(f.get(D,h)?.resolve(y.events),g?.log("verbose",`fulfilled a bucket for key=${D}`))}i?.eventFetched(h),i?.setNumBufferedEvents(u.numBufferedItems())}}catch(N){if(Ze(N)){g?.log("error",N),i?.setRelayStatus(h,"failed"),b();break}if(Ge(N))g?.log("info",N.message),q=!0;else{g?.log("error","unexpected error:",N),i?.setRelayStatus(h,"failed"),b();break}}finally{i?.subClosed()}if(!C){g?.log("info",`got ${x.size} events`),i?.setRelayStatus(h,q?"aborted":"completed"),b();break}if(s.abortSignal?.aborted){g?.log("info","aborted"),i?.setRelayStatus(h,q?"aborted":"completed"),b();break}R=A,i?.setRelayFrontier(h,A)}})),Promise.all(l.map(async h=>{let d=this.#n?.subLogger(wn(String(h),6)),g=await Promise.all(f.itemsByKey(h)?.map(x=>x.promise)??[]);d?.log("verbose","fulfilled all buckets for this key");let R=(()=>{let x=[],b=new Set;for(let m of g)for(let O of m)b.has(O.id)||(x.push(O),b.add(O.id));return x})();R.sort(st);let T=(()=>{if(s.skipVerification||!s.reduceVerification)return R.slice(0,o);let x=[];for(let b of R)if(Ne(b)&&(x.push(b),x.length>=o))break;return x})();s.withSeenOn?u.send({key:h,events:T.map(x=>({...x,seenOn:w.getSeenOn(x.id)}))}):u.send({key:h,events:T}),i?.addProgress(1)})).then(()=>{u.close(),i?.stop()}),yield*S}async*fetchLastEventPerKey(e,n,r,o={}){let s={...it,abortSubBeforeEoseTimeoutMs:1e3,...o},i=this.fetchLatestEventsPerKey(e,n,r,1,s);for await(let{key:a,events:c}of i)yield{key:a,event:c[0]}}async*fetchLatestEventsPerAuthor(e,n,r,o={}){for await(let{key:s,events:i}of this.fetchLatestEventsPerKey("authors",An(e),n,r,o))yield{author:s,events:i}}async*fetchLastEventPerAuthor(e,n,r={}){for await(let{key:o,event:s}of this.fetchLastEventPerKey("authors",An(e),n,r))yield{author:o,event:s}}shutdown(){this.#e.shutdown()}};export{ye as NostrFetchError,Nn as NostrFetcher,Er as eventKind,Xe as normalizeRelayUrl,pe as normalizeRelayUrlSet};
/*! Bundled license information:

@noble/hashes/esm/utils.js:
  (*! noble-hashes - MIT License (c) 2022 Paul Miller (paulmillr.com) *)

@noble/curves/esm/abstract/utils.js:
  (*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) *)

@noble/curves/esm/abstract/modular.js:
  (*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) *)

@noble/curves/esm/abstract/curve.js:
  (*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) *)

@noble/curves/esm/abstract/weierstrass.js:
  (*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) *)

@noble/curves/esm/_shortw_utils.js:
  (*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) *)

@noble/curves/esm/secp256k1.js:
  (*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) *)
*/
//# sourceMappingURL=index.mjs.map
